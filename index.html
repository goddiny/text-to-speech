<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Voice to Text —Å —É–º–Ω–æ–π –ø—É–Ω–∫—Ç—É–∞—Ü–∏–µ–π</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 10px 20px; font-size: 18px; }
        #output { margin-top: 20px; font-size: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <button id="startBtn">üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <p id="output"></p>

    <script>
        const startBtn = document.getElementById('startBtn');
        const output = document.getElementById('output');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.lang = 'ru-RU';
        recognition.interimResults = true;
        recognition.continuous = true;

        let recording = false;
        let lastResultTime = Date.now();
        let fullText = '';

        function addPunctuationDuringSpeech(text) {
            text = text.trim();
            text = text.charAt(0).toUpperCase() + text.slice(1);

            if (!/[.!?]$/.test(text)) {
                text += '.';
            }
            text = text.replace(/\s+(–Ω–æ|–∞|–æ–¥–Ω–∞–∫–æ)\s+/gi, ', $1 ');
            text = text.replace(/\s+(—á—Ç–æ|—á—Ç–æ–±—ã)\s+/gi, ', $1 ');

            return text;
        }

        function smartFinalizePunctuation(text) {
            text = text.trim();
            text = text.replace(/\s+/g, ' ');
            text = text.replace(/,\s*([.!?])/g, '$1');
            text = text.replace(/(^|[.!?]\s+)([–∞-—è—ë])/g, (_, sep, letter) => sep + letter.toUpperCase());

            const questionWords = ['–∫—Ç–æ', '—á—Ç–æ', '–≥–¥–µ', '–∫–æ–≥–¥–∞', '–∑–∞—á–µ–º', '–ø–æ—á–µ–º—É', '–∫–∞–∫'];
            let firstWord = text.split(/\s+/)[0].toLowerCase();
            if (questionWords.includes(firstWord)) {
                text = text.replace(/[.!?]?$/, '?');
            } else {
                text = text.replace(/[.!?]?$/, '.');
            }
            return text;
        }

        recognition.onresult = function(event) {
            let currentTime = Date.now();
            let result = event.results[event.results.length - 1];

            if (result.isFinal) {
                let textChunk = result[0].transcript.trim();

                if (currentTime - lastResultTime > 1200 && fullText) {
                    if (!/[.!?]$/.test(fullText)) {
                        fullText += '. ';
                    }
                } else if (currentTime - lastResultTime > 500 && fullText) {
                    if (!/[,.:;!?]$/.test(fullText)) {
                        fullText += ', ';
                    }
                }

                fullText += textChunk;
                output.textContent = addPunctuationDuringSpeech(fullText);
                lastResultTime = currentTime;
            }
        };

        recognition.onerror = function(event) {
            output.textContent = '–û—à–∏–±–∫–∞: ' + event.error;
        };

        recognition.onend = function() {
            if (recording) {
                recognition.start(); // –∞–≤—Ç–æ–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
            } else {
                fullText = smartFinalizePunctuation(fullText);
                output.textContent = fullText;
            }
        };

        startBtn.onclick = async () => {
            if (!recording) {
                // –ü–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                await navigator.mediaDevices.getUserMedia({ audio: true });
                fullText = '';
                recording = true;
                startBtn.textContent = '‚ñ† –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
                recognition.start();
            } else {
                recording = false;
                startBtn.textContent = 'üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
                recognition.stop();
            }
        };
    </script>
</body>
</html>