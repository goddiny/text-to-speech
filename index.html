<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Голосовой Ввод Текста</title>
	<style>
		:root {
			--bg-color: #1a202c;
			--text-color: #f0f4f8;
			--container-bg: #2d3748;
			--container-shadow: rgba(0, 0, 0, 0.3);
			--textarea-border: #4a5568;
			--textarea-bg: #2d3748;
			--textarea-text: #ffffff;
			--status-color: #63b3ed;
			--button-mic-bg: #6366f1;
			--button-mic-hover-bg: #4f46e5;
			--button-clear-bg: #ef4444;
			--button-clear-hover-bg: #dc2626;
			--toggle-border: #a0aec0;
			--toggle-checked-bg: #63b3ed;
			--toggle-checked-text: #1a202c;
			--toggle-button-hover-bg: #4a5568;
			--drunk-button-bg: #d1b439;
			--drunk-button-hover-bg: #c0a12e;
			--game-bg-color: #424e66;
			--game-text-color: #f0f4f8;
			--pipe-color: #38a169;
			--bird-color: #f6ad55;
		}

		.light-mode {
			--bg-color: #f0f4f8;
			--text-color: #1a202c;
			--container-bg: #ffffff;
			--container-shadow: rgba(0, 0, 0, 0.1);
			--textarea-border: #cbd5e0;
			--textarea-bg: #f8f8f8;
			--textarea-text: #1a202c;
			--status-color: #4299e1;
			--button-mic-bg: #4346e5;
			--button-mic-hover-bg: #3c41cf;
			--button-clear-bg: #e53e3e;
			--button-clear-hover-bg: #c53030;
			--toggle-border: #718096;
			--toggle-checked-bg: #4299e1;
			--toggle-checked-text: #ffffff;
			--toggle-button-hover-bg: #e2e8f0;
			--drunk-button-bg: #e5c84a;
			--drunk-button-hover-bg: #d4b63e;
			--game-bg-color: #81c784;
			--game-text-color: #1a202c;
			--pipe-color: #2f855a;
			--bird-color: #f6ad55;
		}

		@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

		body {
			font-family: 'Inter', sans-serif;
			background-color: var(--bg-color);
			color: var(--text-color);
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			margin: 0;
			padding: 20px;
			box-sizing: border-box;
			transition: background-color 0.3s, color 0.3s;
		}

		.container {
			background-color: var(--container-bg);
			border-radius: 16px;
			box-shadow: 0 10px 30px var(--container-shadow);
			padding: 32px;
			width: 100%;
			max-width: 600px;
			text-align: center;
			display: flex;
			flex-direction: column;
			gap: 24px;
			position: relative;
			transition: background-color 0.3s, box-shadow 0.3s;
		}

		h1,
		h2 {
			font-size: 2rem;
			font-weight: 700;
			color: var(--text-color);
			margin-bottom: 0;
			transition: color 0.3s;
		}

		h2 {
			margin-top: 24px;
		}

		.description {
			font-size: 1rem;
			color: var(--toggle-border);
			margin-top: -8px;
			transition: color 0.3s;
		}

		#result-text {
			width: 80%;
			min-height: 200px;
			padding: 16px;
			border: 2px solid var(--textarea-border);
			border-radius: 12px;
			font-size: 1rem;
			font-family: 'Inter', sans-serif;
			color: var(--textarea-text);
			background-color: var(--textarea-bg);
			transition: border-color 0.3s, background-color 0.3s, color 0.3s;
			resize: vertical;
			text-align: left;
			margin: 0 auto;
		}

		#result-text:focus {
			outline: none;
			border-color: var(--status-color);
		}

		#status-message {
			font-size: 0.9rem;
			color: var(--status-color);
			min-height: 20px;
			transition: color 0.3s;
		}

		.button-group {
			display: flex;
			justify-content: center;
			gap: 16px;
		}

		.btn {
			padding: 12px 24px;
			font-size: 1rem;
			font-weight: 500;
			border: none;
			border-radius: 9999px;
			cursor: pointer;
			transition: transform 0.2s, box-shadow 0.2s;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			position: relative;
			transition: transform 0.2s ease-out;
		}

		.btn:active {
			transform: translateY(1px);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.btn-mic {
			background-color: var(--button-mic-bg);
			color: white;
			display: flex;
			align-items: center;
			gap: 8px;
			transition: background-color 0.3s;
		}

		.btn-drunk {
			background-color: var(--drunk-button-bg);
			color: white;
			transition: background-color 0.3s;
		}

		.btn-clear {
			background-color: var(--button-clear-bg);
			color: white;
			transition: background-color 0.3s;
		}

		.btn-mic:hover {
			background-color: var(--button-mic-hover-bg);
		}

		.btn-drunk:hover {
			background-color: var(--drunk-button-hover-bg);
		}

		.btn-clear:hover {
			background-color: var(--button-clear-hover-bg);
		}

		.mic-icon {
			width: 24px;
			height: 24px;
		}

		.toggle-option {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 8px;
			color: var(--toggle-border);
			font-size: 0.9rem;
			transition: color 0.3s;
		}

		.toggle-option input[type="checkbox"] {
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			width: 20px;
			height: 20px;
			border: 2px solid var(--toggle-border);
			border-radius: 4px;
			cursor: pointer;
			position: relative;
			transition: background-color 0.3s, border-color 0.3s;
		}

		.toggle-option input[type="checkbox"]:checked {
			background-color: var(--toggle-checked-bg);
			border-color: var(--toggle-checked-bg);
		}

		.toggle-option input[type="checkbox"]:checked::after {
			content: '✓';
			font-size: 14px;
			color: var(--toggle-checked-text);
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		.theme-toggle-button {
			position: absolute;
			top: 20px;
			right: 20px;
			background: transparent;
			border: none;
			cursor: pointer;
			color: var(--toggle-border);
			transition: color 0.3s;
			padding: 8px;
			border-radius: 50%;
		}

		.theme-toggle-button:hover {
			background-color: var(--toggle-button-hover-bg);
		}

		.theme-icon {
			width: 24px;
			height: 24px;
		}

		/* Анимация "пьяного режима" */
		@keyframes drunk-float {
			0% {
				transform: translate(0, 0) rotate(0deg);
			}

			25% {
				transform: translate(50px, -50px) rotate(-90deg);
			}

			50% {
				transform: translate(100px, 0) rotate(-180deg);
			}

			75% {
				transform: translate(50px, 50px) rotate(-270deg);
			}

			100% {
				transform: translate(0, 0) rotate(-360deg);
			}
		}

		@keyframes rainbow-colors {
			0% {
				filter: hue-rotate(0deg);
			}

			100% {
				filter: hue-rotate(360deg);
			}
		}

		@keyframes body-bg-rainbow {
			0% {
				background-color: #ff0000;
			}

			16% {
				background-color: #ff7f00;
			}

			33% {
				background-color: #ffff00;
			}

			50% {
				background-color: #00ff00;
			}

			66% {
				background-color: #0000ff;
			}

			83% {
				background-color: #4b0082;
			}

			100% {
				background-color: #ff0000;
			}
		}

		.drunk-mode-active .container {
			animation: drunk-float 3s linear infinite, rainbow-colors 3s linear infinite;
		}

		.drunk-mode-active body {
			animation: body-bg-rainbow 6s linear infinite;
		}

		/* Стили для игры */
		#game-container {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 16px;
			margin-top: 24px;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
		}

		#game-canvas {
			background-color: var(--game-bg-color);
			border-radius: 12px;
			transition: background-color 0.3s;
			touch-action: none;
			/* Предотвращает масштабирование на мобильных устройствах */
		}

		.game-title {
			margin-top: 24px;
			margin-bottom: 0;
			color: var(--text-color);
		}
	</style>
</head>

<body>
	<div class="container">
		<button id="theme-toggle-button" class="theme-toggle-button">
			<svg id="theme-icon" class="theme-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
				fill="currentColor">
				<path
					d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 7.5a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H8.25a.75.75 0 01-.75-.75zM4.5 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H5.25a.75.75 0 01-.75-.75zM7.5 16.5a.75.75 0 01-.75.75H4.5a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM12 19.5a.75.75 0 01-.75.75h2.25a.75.75 0 010 1.5H12a.75.75 0 01-.75-.75zM16.5 16.5a.75.75 0 01-.75.75h2.25a.75.75 0 010-1.5h-2.25a.75.75 0 01.75.75zM19.5 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM16.5 7.5a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5h-2.25a.75.75 0 01-.75-.75zM12 8.25a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5z" />
			</svg>
		</button>
		<h1>Голосовой Ввод</h1>
		<p class="description">Нажмите на микрофон и начните говорить.</p>
		<div class="toggle-option">
			<input type="checkbox" id="no-gemini-toggle">
			<label for="no-gemini-toggle">Без Gemini (только базовая пунктуация)</label>
		</div>
		<textarea id="result-text" placeholder="Ваш текст появится здесь..."></textarea>
		<div id="status-message"></div>
		<div class="button-group">
			<button id="mic-button" class="btn btn-mic">
				<svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
					<path d="M12 2a3 3 0 013 3v7a3 3 0 01-6 0V5a3 3 0 013-3z" />
					<path d="M19 12a7 7 0 01-14 0v-1a1 1 0 00-2 0v1a9 9 0 0018 0v-1a1 1 0 00-2 0v1z" />
					<path d="M12 22a2 2 0 002-2v-1a1 1 0 00-2 0v1a2 2 0 00-2 2h2z" />
				</svg>
				Начать запись
			</button>
			<button id="clear-button" class="btn btn-clear">
				Стереть
			</button>
			<button id="drunk-mode-button" class="btn btn-drunk">
				Пьяный режим
			</button>
		</div>

		<!-- Игра Flappy Bird -->
		<h2 class="game-title">Flappy Bird</h2>
		<div id="game-container">
			<canvas id="game-canvas"></canvas>
		</div>
	</div>

	<script>
		// Проверка поддержки Web Speech API
		window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

		if (typeof SpeechRecognition === 'undefined') {
			const container = document.querySelector('.container');
			container.innerHTML = '<h1>Ошибка</h1><p class="description">К сожалению, ваш браузер не поддерживает распознавание речи. Попробуйте использовать Chrome, Firefox или Safari.</p>';
		} else {
			const recognition = new SpeechRecognition();
			const resultTextarea = document.getElementById('result-text');
			const micButton = document.getElementById('mic-button');
			const clearButton = document.getElementById('clear-button');
			const statusMessage = document.getElementById('status-message');
			const noGeminiToggle = document.getElementById('no-gemini-toggle');
			const themeToggleButton = document.getElementById('theme-toggle-button');
			const themeIcon = document.getElementById('theme-icon');
			const drunkModeButton = document.getElementById('drunk-mode-button');
			const allButtons = document.querySelectorAll('.btn');

			// Настройки распознавания
			recognition.continuous = true;
			recognition.interimResults = true;
			recognition.lang = 'ru-RU';

			let isListening = false;
			let rawTranscript = '';
			let isDrunkModeActive = false;

			// API endpoint для Gemini
			const apiKey = "";
			const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

			// Мап для хранения обработчиков событий, чтобы их можно было удалить
			const buttonEventListeners = new Map();

			// Функция для отправки текста в Gemini API
			async function getPunctuatedTextWithGemini(text) {
				statusMessage.textContent = 'Обработка текста через Gemini...';

				const systemPrompt = "Ты — специалист по редактированию текста. Твоя единственная задача — вернуть исправленный текст без каких-либо дополнительных слов, фраз или объяснений.";
				const userQuery = `Исправь пунктуацию и грамматику в следующем тексте: "${text}"`;

				const payload = {
					contents: [{ parts: [{ text: userQuery }] }],
					systemInstruction: { parts: [{ text: systemPrompt }] }
				};

				// Логика экспоненциальной задержки при ошибках
				const maxRetries = 5;
				let retries = 0;
				let delay = 1000;

				while (retries < maxRetries) {
					try {
						const response = await fetch(apiUrl, {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify(payload)
						});

						if (response.ok) {
							const result = await response.json();
							return result.candidates?.[0]?.content?.parts?.[0]?.text || '';
						} else {
							console.error('Ошибка API:', response.status, await response.text());
							throw new Error('API error');
						}
					} catch (error) {
						retries++;
						if (retries < maxRetries) {
							await new Promise(res => setTimeout(res, delay));
							delay *= 2;
						} else {
							console.error('Не удалось получить ответ от Gemini API после нескольких попыток.', error);
							return text; // Возвращаем исходный текст, чтобы избежать сбоя
						}
					}
				}
			}

			// Простая функция для расстановки пунктуации без Gemini
			function getBasicPunctuatedText(text) {
				statusMessage.textContent = 'Обработка текста...';

				let formattedText = text.trim().replace(/\s{2,}/g, ' ');
				if (formattedText.length > 0) {
					formattedText = formattedText.charAt(0).toUpperCase() + formattedText.slice(1);
				}
				formattedText = formattedText.replace(/([.?!])\s*([a-zа-яё])/g, (match, p1, p2) => {
					return p1 + ' ' + p2.toUpperCase();
				});
				const lastChar = formattedText.charAt(formattedText.length - 1);
				if (lastChar !== '.' && lastChar !== '?' && lastChar !== '!') {
					formattedText += '.';
				}
				formattedText = formattedText.replace(/ а /g, ', а ')
					.replace(/ но /g, ', но ')
					.replace(/ и /g, ', и ');

				return formattedText;
			}

			// Логика переключения тем
			const sunIcon = `<path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 7.5a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H8.25a.75.75 0 01-.75-.75zM4.5 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H5.25a.75.75 0 01-.75-.75zM7.5 16.5a.75.75 0 01-.75.75H4.5a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM12 19.5a.75.75 0 01-.75.75h2.25a.75.75 0 010 1.5H12a.75.75 0 01-.75-.75zM16.5 16.5a.75.75 0 01-.75.75h2.25a.75.75 0 010-1.5h-2.25a.75.75 0 01.75.75zM19.5 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM16.5 7.5a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5h-2.25a.75.75 0 01-.75-.75zM12 8.25a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5z" />`;
			const moonIcon = `<path d="M9.53 2.59a7.5 7.5 0 00-6.17 12.8A7.5 7.5 0 0012 22.5h.75a.75.75 0 00.75-.75V19.5a3 3 0 013-3h2.25a.75.75 0 00.75-.75V12a9 9 0 00-8.97-9.52l-.2-.03z"/>`;

			function setTheme(isLight) {
				if (isLight) {
					document.body.classList.add('light-mode');
					themeIcon.innerHTML = moonIcon;
					localStorage.setItem('theme', 'light');
				} else {
					document.body.classList.remove('light-mode');
					themeIcon.innerHTML = sunIcon;
					localStorage.setItem('theme', 'dark');
				}
			}

			// Проверка сохраненной темы при загрузке страницы
			const savedTheme = localStorage.getItem('theme');
			if (savedTheme === 'light') {
				setTheme(true);
			} else {
				setTheme(false);
			}

			// Обработчик для кнопки переключения темы
			themeToggleButton.addEventListener('click', () => {
				const isLight = document.body.classList.contains('light-mode');
				setTheme(!isLight);
			});

			// Логика для "пьяного режима"
			function handleDrunkMode(event) {
				const button = event.currentTarget;
				const rect = button.getBoundingClientRect();
				const mouseX = event.clientX;
				const mouseY = event.clientY;

				const center_x = rect.left + rect.width / 2;
				const center_y = rect.top + rect.height / 2;

				const dx = mouseX - center_x;
				const dy = mouseY - center_y;

				const distance = Math.sqrt(dx * dx + dy * dy);
				const maxDistance = 150;
				const maxOffset = 50;

				if (distance < maxDistance) {
					const angle = Math.atan2(dy, dx);
					const offset = (1 - distance / maxDistance) * maxOffset;
					const newX = -Math.cos(angle) * offset;
					const newY = -Math.sin(angle) * offset;

					button.style.transform = `translate(${newX}px, ${newY}px) rotate(${Math.random() * 2 - 1}deg)`;
				} else {
					button.style.transform = 'translate(0, 0) rotate(0deg)';
				}
			}

			function resetTransform(event) {
				event.currentTarget.style.transform = 'translate(0, 0) rotate(0deg)';
			}

			drunkModeButton.addEventListener('click', () => {
				isDrunkModeActive = !isDrunkModeActive;
				document.body.classList.toggle('drunk-mode-active', isDrunkModeActive);

				if (isDrunkModeActive) {
					drunkModeButton.textContent = 'Нормальный режим';
					allButtons.forEach(button => {
						const moveHandler = (e) => handleDrunkMode(e);
						const leaveHandler = (e) => resetTransform(e);
						button.addEventListener('mousemove', moveHandler);
						button.addEventListener('mouseleave', leaveHandler);
						buttonEventListeners.set(button, { move: moveHandler, leave: leaveHandler });
					});
				} else {
					drunkModeButton.textContent = 'Пьяный режим';
					allButtons.forEach(button => {
						const handlers = buttonEventListeners.get(button);
						if (handlers) {
							button.removeEventListener('mousemove', handlers.move);
							button.removeEventListener('mouseleave', handlers.leave);
							button.style.transform = '';
							buttonEventListeners.delete(button);
						}
					});
				}
			});

			// Обработчик для кнопки микрофона
			micButton.addEventListener('click', async () => {
				if (isListening) {
					recognition.stop();
					isListening = false;
					micButton.innerHTML = `<svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a3 3 0 013 3v7a3 3 0 01-6 0V5a3 3 0 013-3z"/><path d="M19 12a7 7 0 01-14 0v-1a1 1 0 00-2 0v1a9 9 0 0018 0v-1a1 1 0 00-2 0v1z"/><path d="M12 22a2 2 0 002-2v-1a1 1 0 00-2 0v1a2 2 0 00-2 2h2z"/></svg> Остановить`;

					let punctuatedText;
					if (noGeminiToggle.checked) {
						punctuatedText = getBasicPunctuatedText(rawTranscript);
					} else {
						punctuatedText = await getPunctuatedTextWithGemini(rawTranscript);
					}

					resultTextarea.value = punctuatedText;
					statusMessage.textContent = 'Готово';

				} else {
					rawTranscript = resultTextarea.value;
					recognition.start();
					isListening = true;
					micButton.innerHTML = `<svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a3 3 0 013 3v7a3 3 0 01-6 0V5a3 3 0 013-3z"/><path d="M19 12a7 7 0 01-14 0v-1a1 1 0 00-2 0v1a9 9 0 0018 0v-1a1 1 0 00-2 0v1z"/><path d="M12 22a2 2 0 002-2v-1a1 1 0 00-2 0v1a2 2 0 00-2 2h2z"/></svg> Начать запись`;
					statusMessage.textContent = 'Слушаю...';
				}
			});

			// Обработчик для распознавания
			recognition.addEventListener('result', (event) => {
				const currentTranscript = event.results[event.results.length - 1][0].transcript;
				const isFinal = event.results[event.results.length - 1].isFinal;

				if (isFinal) {
					if (rawTranscript.length > 0 && !rawTranscript.endsWith(' ')) {
						rawTranscript += ' ';
					}
					rawTranscript += currentTranscript;
				}

				resultTextarea.value = rawTranscript;
			});

			// Обработчик для ошибки
			recognition.addEventListener('error', (event) => {
				console.error('Ошибка распознавания:', event.error);
				if (event.error !== 'aborted' && isListening) {
					recognition.start();
				} else {
					isListening = false;
					micButton.innerHTML = `<svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a3 3 0 013 3v7a3 3 0 01-6 0V5a3 3 0 013-3z"/><path d="M19 12a7 7 0 01-14 0v-1a1 1 0 00-2 0v1a9 9 0 0018 0v-1a1 1 0 00-2 0v1z"/><path d="M12 22a2 2 0 002-2v-1a1 1 0 00-2 0v1a2 2 0 00-2 2h2z"/></svg> Начать запись`;
					statusMessage.textContent = 'Готово';
				}
			});

			// Обработчик для остановки распознавания (например, когда микрофон сам отключился)
			recognition.addEventListener('end', () => {
				if (isListening) {
					recognition.start();
				}
			});

			// Обработчик для кнопки "Стереть"
			clearButton.addEventListener('click', () => {
				recognition.stop();
				isListening = false;
				resultTextarea.value = '';
				rawTranscript = '';
				statusMessage.textContent = '';
				micButton.innerHTML = `<svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a3 3 0 013 3v7a3 3 0 01-6 0V5a3 3 0 013-3z"/><path d="M19 12a7 7 0 01-14 0v-1a1 1 0 00-2 0v1a9 9 0 0018 0v-1a1 1 0 00-2 0v1z"/><path d="M12 22a2 2 0 002-2v-1a1 1 0 00-2 0v1a2 2 0 00-2 2h2z"/></svg> Начать запись`;
			});
		}

		// ======================================
		// КОД ИГРЫ FLAPPY BIRD
		// ======================================

		window.onload = function () {
			const canvas = document.getElementById('game-canvas');
			const ctx = canvas.getContext('2d');

			let gameFrame;
			let gameRunning = false;
			let isPaused = false;

			// Настройка размера канваса
			function setupCanvas() {
				canvas.width = Math.min(window.innerWidth * 0.8, 400);
				canvas.height = Math.min(window.innerHeight * 0.6, 500);
			}
			setupCanvas();
			window.addEventListener('resize', setupCanvas);

			// Игровые переменные
			let bird = {
				x: 50,
				y: canvas.height / 2,
				width: 30,
				height: 25,
				velocity: 0,
				gravity: 0.5,
				jump: -9
			};

			let pipes = [];
			const pipeWidth = 50;
			const pipeGap = 150;
			let pipeSpawnRate = 120; // Каждые 120 кадров
			let frameCount = 0;
			let score = 0;
			let highScore = localStorage.getItem('flappyHighScore') || 0;

			// Функции для рисования
			function drawBird() {
				ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bird-color');
				ctx.beginPath();
				ctx.arc(bird.x, bird.y, bird.width / 2, 0, Math.PI * 2);
				ctx.fill();
			}

			function drawPipes() {
				ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--pipe-color');
				for (let i = 0; i < pipes.length; i++) {
					let p = pipes[i];
					ctx.fillRect(p.x, 0, p.width, p.top);
					ctx.fillRect(p.x, canvas.height - p.bottom, p.width, p.bottom);
				}
			}

			function drawScore() {
				ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--game-text-color');
				ctx.font = "2rem 'Inter'";
				ctx.textAlign = "center";
				ctx.fillText(score, canvas.width / 2, 50);
			}

			function drawMessage(text) {
				ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
				ctx.font = "1.5rem 'Inter'";
				ctx.textAlign = "center";
				ctx.fillText(text, canvas.width / 2, canvas.height / 2);
			}

			// Игровая логика
			function update() {
				if (isPaused) return;

				// Обновление птицы
				bird.velocity += bird.gravity;
				bird.y += bird.velocity;

				// Обновление труб
				for (let i = pipes.length - 1; i >= 0; i--) {
					pipes[i].x -= 2;
					if (pipes[i].x + pipes[i].width < 0) {
						pipes.splice(i, 1);
					}
				}

				// Создание новой трубы
				frameCount++;
				if (frameCount % pipeSpawnRate === 0) {
					let minHeight = 50;
					let maxHeight = canvas.height - pipeGap - minHeight;
					let randomHeight = Math.floor(Math.random() * (maxHeight - minHeight + 1)) + minHeight;
					pipes.push({
						x: canvas.width,
						width: pipeWidth,
						top: randomHeight,
						bottom: canvas.height - randomHeight - pipeGap
					});
				}

				// Проверка набора очков
				for (let i = 0; i < pipes.length; i++) {
					if (bird.x > pipes[i].x + pipes[i].width && !pipes[i].scored) {
						score++;
						pipes[i].scored = true;
					}
				}

				// Проверка столкновений
				if (bird.y + bird.height > canvas.height || bird.y < 0) {
					endGame();
				}

				for (let i = 0; i < pipes.length; i++) {
					let p = pipes[i];
					if (bird.x + bird.width > p.x && bird.x < p.x + p.width) {
						if (bird.y < p.top || bird.y + bird.height > canvas.height - p.bottom) {
							endGame();
						}
					}
				}
			}

			// Основной игровой цикл
			function gameLoop() {
				if (!gameRunning) {
					return;
				}
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				update();
				drawPipes();
				drawBird();
				drawScore();
				gameFrame = requestAnimationFrame(gameLoop);
			}

			// Запуск игры
			function startGame() {
				if (gameRunning) return;
				gameRunning = true;
				bird.y = canvas.height / 2;
				bird.velocity = 0;
				pipes = [];
				score = 0;
				frameCount = 0;
				gameLoop();
			}

			// Завершение игры
			function endGame() {
				gameRunning = false;
				cancelAnimationFrame(gameFrame);

				if (score > highScore) {
					highScore = score;
					localStorage.setItem('flappyHighScore', highScore);
				}

				drawGameOverMessage();
			}

			function drawGameOverMessage() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				drawPipes();
				drawBird();
				drawScore();
				drawMessage(`Игра окончена! Счет: ${score}`);
				ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--game-text-color');
				ctx.font = "1rem 'Inter'";
				ctx.fillText(`Рекорд: ${highScore}`, canvas.width / 2, canvas.height / 2 + 30);
			}

			function drawInitialMessage() {
				drawMessage('Нажмите, чтобы начать');
				ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--game-text-color');
				ctx.font = "1rem 'Inter'";
				ctx.fillText(`Рекорд: ${highScore}`, canvas.width / 2, canvas.height / 2 + 30);
			}

			// Управление
			function flap() {
				if (!gameRunning) {
					startGame();
					return;
				}
				bird.velocity = bird.jump;
			}

			canvas.addEventListener('mousedown', flap);
			canvas.addEventListener('touchstart', flap);
			document.addEventListener('keydown', (e) => {
				if (e.code === 'Space') {
					flap();
				}
			});

			// Initial draw on canvas to show the "Нажмите, чтобы начать" message
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			drawInitialMessage();
		}
	</script>
</body>

</html>