<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Voice to Text —Å –∞–≤—Ç–æ–ø—É–Ω–∫—Ç—É–∞—Ü–∏–µ–π –∏ —É–º–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 10px 20px; font-size: 18px; }
        #output { margin-top: 20px; font-size: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <button id="startBtn">üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <p id="output"></p>

    <script>
        const startBtn = document.getElementById('startBtn');
        const output = document.getElementById('output');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.lang = 'ru-RU';
        recognition.interimResults = true;
        recognition.continuous = true;

        let lastResultTime = Date.now();
        let fullText = '';

        function addPunctuationDuringSpeech(text) {
            text = text.trim();
            text = text.charAt(0).toUpperCase() + text.slice(1);

            if (!/[.!?]$/.test(text)) {
                text += '.';
            }

            text = text.replace(/\s+(–Ω–æ|–∞|–æ–¥–Ω–∞–∫–æ)\s+/gi, ', $1 ');
            text = text.replace(/\s+(—á—Ç–æ|—á—Ç–æ–±—ã)\s+/gi, ', $1 ');

            return text;
        }

        function smartFinalizePunctuation(text) {
            text = text.trim();

            // –£–±–∏—Ä–∞–µ–º –¥–≤–æ–π–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
            text = text.replace(/\s+/g, ' ');

            // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ –ø–µ—Ä–µ–¥ —Ç–æ—á–∫–∞–º–∏/–≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏/–≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏
            text = text.replace(/,\s*([.!?])/g, '$1');

            // –ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –≤ –∫–∞–∂–¥–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –∑–∞–≥–ª–∞–≤–Ω–∞—è
            text = text.replace(/(^|[.!?]\s+)([–∞-—è—ë])/g, (_, sep, letter) => sep + letter.toUpperCase());

            // –ï—Å–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ–≤–∞ ‚Äî —Å—Ç–∞–≤–∏–º –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π
            const questionWords = ['–∫—Ç–æ', '—á—Ç–æ', '–≥–¥–µ', '–∫–æ–≥–¥–∞', '–∑–∞—á–µ–º', '–ø–æ—á–µ–º—É', '–∫–∞–∫'];
            let firstWord = text.split(/\s+/)[0].toLowerCase();
            if (questionWords.includes(firstWord)) {
                text = text.replace(/[.!?]?$/, '?');
            } else {
                text = text.replace(/[.!?]?$/, '.');
            }

            return text;
        }

        recognition.onresult = function(event) {
            let currentTime = Date.now();
            let textChunk = event.results[event.results.length - 1][0].transcript.trim();

            if (currentTime - lastResultTime > 1200 && fullText) {
                if (!/[.!?]$/.test(fullText)) {
                    fullText += '. ';
                }
            } else if (currentTime - lastResultTime > 500 && fullText) {
                if (!/[,.:;!?]$/.test(fullText)) {
                    fullText += ', ';
                }
            }

            fullText += textChunk;
            output.textContent = addPunctuationDuringSpeech(fullText);
            lastResultTime = currentTime;
        };

        recognition.onerror = function(event) {
            output.textContent = '–û—à–∏–±–∫–∞: ' + event.error;
        };

        recognition.onend = function() {
            fullText = smartFinalizePunctuation(fullText);
            output.textContent = fullText;
        };

        startBtn.onclick = () => {
            fullText = '';
            recognition.start();
        };
    </script>
</body>
</html>